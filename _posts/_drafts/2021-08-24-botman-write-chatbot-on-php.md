---
layout: post
title: Botman — пишем чатбот на php
categories: Botman Чатботы
---

Компания ЭФКО организовывает митап посвященный чатботам и меня пригласили выступить с докладом - [Botman — пишем чатбот на php](https://efko-cr.timepad.ru/event/1700504/).

Как обычно изложу свои мысли сначала текстом и начну с конца, как в хорошем ООП. 

## Выводы 

**Botman** - framework для разработки чатботов. [Официальный сайт](https://botman.io/) даже завявляет - что это самый популярный PHP фреймворк, не могу это доказать или опровергнуть. 

Вам он подойдет, если:

**Нужен бот под разные платформы.** Не стоит выбирать ботман, если вам нужен конкретно телеграмм бот, например. Хотя это достаточно легковесная платформа, но излишняя сложность ради кроссплатформенности все равно присутствует. 

**Логика уже написана на php.** Возможно вам подойдет какой-то конструктор ботов? Если у вас нет готовых пакетов которые вы будете использовать в этом фреймворке есть смысл задуматься о nocode решении.  

**Нет претензий к интерфейсу.** В угоду кроссплатформенности урезаны практически любые возможности форматирования сообщений. Об этом еще поговорим. 


Можно было закончить на этом, но давайте углубимся еще немного. 

## Преимущества 

**Приятный синтаксис**

```php
$botman->hears('Call me {name}', function($bot, $name) {
    $bot->reply('Hi ' . $name);
});
```

Мне нравится как это выглядит. Ничего лишнего. 

**Кроссплатформенность**

Единый код будет работать под разные платформы. Есть драйвера под главные Telegram, Facebook, VK ... на github можно поискать еще драйверов для botman. Судя по-всему драйвера пишутся достаточно легко, хотя я не пробовал. 

**Middlewares**

Можно писать собственный мидлвари для входящих и исходящих сообщений. 

```php
use BotMan\BotMan\Interfaces\Middleware\Received;

class MyMiddleware implements Received
{
    public function received(IncomingMessage $message, $next, BotMan $bot)
    {
        ...
        return $next($message);
    }
}
```

Это удобно для организации статистики вашего ЧатБота. Очень рекоммендую подумать какие ваши целевые показатели и что вам нужно логировать. 

Мидлвари можно применять ко всем сообщениям или к некоторым группам. Все достаточно очевидно. 

**Conversations**

Крутая штука для организации диалога по заданной теме, например можно собрать данные у пользователя в пошаговом диалоге. 

```php
$botman->hears('Hello', function($bot) {
    $bot->startConversation(new OnboardingConversation);
});

class OnboardingConversation extends Conversation
{
    protected $firstname;
    protected $email;

    public function run()
    {
        $this->askFirstname();
    }

    public function askFirstname()
    {
        $this->ask('Hello! What is your firstname?', function(Answer $answer) {
            $this->firstname = $answer->getText();
            $this->askEmail();
        });
    }

    public function askEmail()
    {
        $this->ask('One more thing - what is your email?', function(Answer $answer) {
            $this->email = $answer->getText();
            $this->say('Great - that is all we need, '.$this->firstname);
        });
    }
}
```

Между запросами экземпляр класса сериализируется и хранится в хранилище ботмана. Единый класс работает между запросами, это очень удобно, не нужно думать про хранение данных между запросами. Но будьте внимательные, не работает Dependency Injection, придется делать new там где вам нужен объект или не забыть про __wakeup. 

**Storing information**

Есть простое хранилище, которое можно использовать тут же в диалоге и которое связано с пользователем. С хранилищами не все гладко, подробнее расскажу в недостатках. 

```php
$bot->userStorage()->save(['gg' => 'hh']);
echo $bot->userStorage()->get('gg');
```

**Botman Studio**

Это тул, который позволяет генерировать бандлы ботмана с Laravel. Что дает немного больше возможностей.

```shell
composer global require "botman/installer"
botman new weatherbot
```

1. Веб-морда на Laravel. Можно вывести статистику или админку бота. 
2. Tinker - крутой инструмент для проверки бота. Можно запускать прям в консоли, также доступен и в веб-интерфейсе. Это прям супер плюс. 
3. Удобная работа с драйверами
4. Написание feature тестов, которые можно запускать в том же gitlab-ci

```php
    public function testBasicTest()
    {
        $this->bot
            ->receives('Hi')
            ->assertReply('Hello!');
    }
```

