---
layout: post
title: Как перейти с 5.3 на 7.2 и вложиться в бюджет
categories: Разработка, legacy, Tools
---

В Воронеже решил познакомиться с местным php сообществом. 
Оказывается Александр Макаров (тот самый в шляпе из yii) живет здесь. Первая моя php конференция была с его участием в Киве :)

20 февраля состоится [митап](https://github.com/phpvrn/meetings/tree/master/2%20%D0%B2%D1%81%D1%82%D1%80%D0%B5%D1%87%D0%B0%20(20.02.21)) на котором мне предложили рассказать про наш опыт перехода на php 7.2 из древнего 5.3.

Материалы: 
* [Ссылка на статью про историю архитектуры для пользователей](https://vetmanager.ru/blog/istoria-arkhitekturi-nashego-servisa?fbclid=IwAR2lEzrZJ4Np-_NTwKyDnhmokKf1u-Whky0VJ6iHSzKs2i62uen9Y34lOok)
* [Архитектура высоких нагрузок](https://ruhighload.com/%D0%90%D1%80%D1%85%D0%B8%D1%82%D0%B5%D0%BA%D1%82%D1%83%D1%80%D0%B0+%D0%B2%D1%8B%D1%81%D0%BE%D0%BA%D0%B8%D1%85+%D0%BD%D0%B0%D0%B3%D1%80%D1%83%D0%B7%D0%BE%D0%BA)

На курсах продуктовых аналитиков меня научили так - сначала вывод, потом обоснование.

## Вывод

1. Крупному проекту джуны нужны
1. Используйте анализаторы кода
1. Переходить нужно - если нужны новые зависимости или нужна производительность

## История 

Ветменеджер - это CRM для ветеринарных клиник и сервис о котором пойдет речь. 

Размер проекта к 2018 году достиг **281к** строк php кода и **41к** js кода. 

Я попал в проект в 2009 году. К этому моменту его уже разрабатывали и кода было уже много. Заказчиком был владелец клиники, который загорелся перенести свою старую программу написанную на Delphi в веб. 

Стоял сервер с debian у него в клинике и вебсервер крутился на нём. Для обновления был написал скрипт, который обновлял репозиторий в директорию и rsyncал файлы в продакшн директорию и запускал миграции.

![Первая архитектура](/images/2021/02/first-arch.png)

Через определенное время мы это опубликовали в веб и каждый мог зарегистрировать клинику при этом и возможность локальной установки у нас осталась.
При регистрации клиники создавалась папка с кодом и отдельная база данных, в неё мы rsyncали файлы с гитхаб и запускали миграции. Имя папки было хостом. Типа domains/mydomain/ тут лежит код и mydomain.vetmanager.ru так я попадаю в свою программу.

![Вторая архитектура](/images/2021/02/second-arch.png)

Появились клиенты. Кол-во пользователей стало рости достаточно быстро, для такой узкой ниши. 

Мы развивались почти так как описано в статье "Архитектура высоких нагрузок", прошли все этапы с нашими маленькими особенностями и уже в конце пути увидели эту статью. Она бы сэкономила немало сил и времени, если бы мы нашли её раньше.

Версии php инрементировались, но все это проходило мимо нас. Бюджеты были небольшие и выделить на это средства не было возможности. Поддержка php 5.3 была прекращена в 2014 году, мы перешли на новую версию языка только в конце 2018 года.

## Можно ли использовать 5.3 в 2021?

Да, это все еще возможно. Мы до сих пор поддерживаем биллинг-сервис на yii1, который отлично работает на 5.3. Его задача отдавать данные о тарифе пользователю и отправлять напоминания. 1-2 раза в год в код даже добавляются какие-то незначительные фичи.

## Стоит ли переходить?

Все это время проект активно развивался, писались все новые фичи и возможности программы. Конечно, мы начали замечать неудобства. 

### Возросло время локального запуска проекта

Докера еще не было. Для локальной разработки нужно было переключать ставить старую версию. Чем больше она устаревала, тем страшнее было убить рабочий линукс. В докер, тоже были проблемы с 5.3 и нашим проектом. 

### Используемые библиотеки перестали обновляться

Найденные баги в сторонних библиотеках пришлось править локально и самостоятельно. Новые возможности библиотек нам были недоступны.

### Новые интеграции были нам недоступны

Интеграции с новыми сервисами стали недоступны для нас или требовали самостоятельной разработки SDK, поскольку все новое уже писалось под новые версии языка. Несколько перспективных фич мы откладывали именно из-за этого.

## Как переходили мы? 

В 2018ом жаренный петух наконец-то клюнул и бизнес одобрил переход. Причем сразу с выделенных серверов в кубернетес. 

Конечно, потребовалось и смена архитектуры. Единый код, который обслуживал бы все запросы. Stateless приложение. Это тема отдельного доклада. 










