---
layout: post
title: Такой неочевидный мемкеш
categories: Memcache Memcached
---

Недавно админы проводили плановые работы на сервере, ничего не предвещало беды, но мы получили неожиданный простой сервиса. 


Имея вот такой конфиг с 3мя серверами нужно было по очереди остановливать сервера мемкеша, проводить работы и вводить в строй. 

```
[session]
session.save_handler  = memcached
session.save_path = "memcached1:11211,memcached2:11211,memcached3:11211"

```

Гладко было на бумаге, да забыли про овраги. При выключении одной ноды с мемкешем сервис полностью стал колом. Интересно как так произошло и что делать? Может у вас тоже такой же конфиг и вы до были спокойны как и мы?

Давайте начнем с начала. По умолчанию у нас вот так. Сессия - это файл доступной для пхп директории. Название файла нам понятно из куки, которую мы отдаем браузеру и браузер нам её приносит при каждом запросе. Берем куку, берем по ней файл - вот нам сессия пользователя. Читаем и пишем в неё. 


```
[session]
session.save_handler  = files
```

Когда у нас 1 php бекенд - проблемы нет, но что если нам нужно несколько бекендов? На каждом бекенде будут свои сессии. Нам нужно единое хранилище. Для этого нам доступны различные хранилища и php модули для работы с ними. Можно даже свое извращение [придумать](https://www.php.net/manual/ru/function.session-set-save-handler.php). Мы используем мемкеш в качестве хранилища. 




